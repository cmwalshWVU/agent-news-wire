# Agent News Wire - GitLab CI/CD Pipeline
# Builds, tests, and deploys to Railway

stages:
  - build
  - test
  - deploy

variables:
  NODE_VERSION: "20"

# =============================================================================
# Build Stage
# =============================================================================

build-api:
  stage: build
  image: node:${NODE_VERSION}-alpine
  script:
    - cd api
    - npm ci
    - npm run build
  artifacts:
    paths:
      - api/dist/
      - api/node_modules/
    expire_in: 1 hour
  cache:
    key: ${CI_COMMIT_REF_SLUG}-api
    paths:
      - api/node_modules/

build-frontend:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - apt-get update && apt-get install -y python3 make g++ libudev-dev libusb-1.0-0-dev
  script:
    - cd frontend
    - npm ci
    - npm run build
  artifacts:
    paths:
      - frontend/.next/
      - frontend/node_modules/
    expire_in: 1 hour
  cache:
    key: ${CI_COMMIT_REF_SLUG}-frontend
    paths:
      - frontend/node_modules/

# =============================================================================
# Test Stage
# =============================================================================

typecheck-api:
  stage: test
  image: node:${NODE_VERSION}-alpine
  needs: ["build-api"]
  script:
    - cd api
    - npm run build  # TypeScript type checking

typecheck-frontend:
  stage: test
  image: node:${NODE_VERSION}
  needs: ["build-frontend"]
  script:
    - cd frontend
    - echo "Type checking passed in build stage"

# =============================================================================
# Deploy Stage - Railway
# =============================================================================

deploy-api:
  stage: deploy
  image: node:${NODE_VERSION}-alpine
  needs: ["typecheck-api"]
  script:
    - echo "Checking Railway credentials..."
    - test -n "$RAILWAY_TOKEN" || (echo "ERROR - RAILWAY_TOKEN not set" && exit 1)
    - test -n "$RAILWAY_PROJECT_ID" || (echo "ERROR - RAILWAY_PROJECT_ID not set" && exit 1)
    - echo "Project ID is $RAILWAY_PROJECT_ID"
    - npm install -g @railway/cli
    - cd api
    - railway whoami
    - railway status || true
    - railway up --service api --detach 2>&1 || (echo "Deploy failed" && exit 1)
  environment:
    name: production
    url: https://$RAILWAY_API_DOMAIN
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  variables:
    RAILWAY_TOKEN: $RAILWAY_TOKEN
    RAILWAY_PROJECT_ID: $RAILWAY_PROJECT_ID

deploy-frontend:
  stage: deploy
  image: node:${NODE_VERSION}
  needs: ["typecheck-frontend"]
  script:
    - echo "Checking Railway credentials..."
    - test -n "$RAILWAY_TOKEN" || (echo "ERROR - RAILWAY_TOKEN not set" && exit 1)
    - test -n "$RAILWAY_PROJECT_ID" || (echo "ERROR - RAILWAY_PROJECT_ID not set" && exit 1)
    - echo "Project ID is $RAILWAY_PROJECT_ID"
    - npm install -g @railway/cli
    - cd frontend
    - railway whoami
    - railway status || true
    - railway up --service frontend --detach 2>&1 || (echo "Deploy failed" && exit 1)
  environment:
    name: production
    url: https://$RAILWAY_FRONTEND_DOMAIN
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  variables:
    RAILWAY_TOKEN: $RAILWAY_TOKEN
    RAILWAY_PROJECT_ID: $RAILWAY_PROJECT_ID

# =============================================================================
# Auto-deploy on main (optional - enable by removing 'when: manual')
# =============================================================================

# deploy-all:
#   stage: deploy
#   image: node:${NODE_VERSION}-alpine
#   needs: ["typecheck-api", "typecheck-frontend"]
#   script:
#     - npm install -g @railway/cli
#     - cd api && railway up --service api --detach
#     - cd ../frontend && railway up --service frontend --detach
#   environment:
#     name: production
#   rules:
#     - if: $CI_COMMIT_BRANCH == "main"
#   variables:
#     RAILWAY_TOKEN: $RAILWAY_TOKEN
#     RAILWAY_PROJECT_ID: $RAILWAY_PROJECT_ID
